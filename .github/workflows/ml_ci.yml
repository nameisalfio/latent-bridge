name: Machine Learning CI

on: [push, pull_request]

jobs:
  test_pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install torch/torchvision CPU-only to save time and resources in CI
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
          # Install remaining project dependencies
          pip install -r requirements.txt

      - name: Generate Evaluation Metrics
        run: |
          # Set PYTHONPATH so Python can locate the 'src' module
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          # Execute test script with no_wandb flag to avoid credential issues in CI
          python scripts/test.py model=spatial_cnn trainer.no_wandb=True paths.data_dir=./data
          python scripts/test.py model=pixel_mlp trainer.no_wandb=True paths.data_dir=./data

      - name: Run Model Regression Tests
        run: |
          export PYTHONPATH=$PYTHONPATH:$(pwd)
          pytest tests/test_model_performance.py